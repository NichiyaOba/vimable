name: CI

on:
  push:
    branches: [main, implement-cicd, add-plug-czgit]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Initialize
        run: make initialize

      - name: Smoke test
        run: |
          nvim --headless -c "quit"
          tmux new-session -d -s test
          tmux kill-session -t test

      - name: Idempotency test
        run: make initialize

      - name: Install cz-git plugin
        run: make add-plug PLUG=cz-git

      - name: Verify cz-git installation
        run: |
          command -v cz
          test -f ~/.czrc
          test -f ~/commitlint.config.js

      - name: Idempotency test (cz-git)
        run: make add-plug PLUG=cz-git
